# 阶段1：构建
FROM rust:1.91.1-slim-bookworm AS builder

# 安装 PostgreSQL 客户端开发库和编译工具
RUN apt-get update && apt-get install -y \
    libpq-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

ARG APP_NAME
ARG FEATURES


WORKDIR /app

# 缓存依赖层（加速后续构建）
COPY . .

RUN cargo build -p laurel-${APP_NAME} --release ${FEATURES}


# 阶段2：运行
FROM debian:bookworm-slim

# 安装运行时依赖（libpq5 和 SSL 证书）
RUN apt-get update && apt-get install -y \
    libpq5 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
ARG APP_NAME

# 创建非 root 用户和组
RUN groupadd -r appgroup && \
    useradd -r -g appgroup -s /bin/false -d /nonexistent appuser

WORKDIR /app

# 复制二进制文件并设置权限
COPY --from=builder --chown=appuser:appgroup /app/target/release/laurel-${APP_NAME} /app/app
COPY --from=builder --chown=appuser:appgroup /app/${APP_NAME}/config/ ./config/

# 切换到非 root 用户
USER appuser:appgroup
CMD ["/bin/sh", "-c", "exec /app/app $OPTIONS"]
## 暴露端口（根据你的应用需要）
#EXPOSE 8080
#
## 健康检查（可选）
#HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
#    CMD ["/app/app", "health"]
#
## 启动应用
#CMD ["/app/app"]